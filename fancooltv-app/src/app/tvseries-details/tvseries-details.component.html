<!-- navigation -->
<app-navbar></app-navbar>
<!-- Series Details -->
<div class="series-details-container">
    <div *ngIf="loading" class="d-flex justify-content-center align-items-center" style="height: 300px">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div *ngIf="error" class="alert alert-danger">
        {{ errorMessage }}
    </div>

    <ng-container *ngIf="!loading && !error && series">
        <div id="backdrop" class="position-relative">
            <div class="position-absolute w-100 h-100" style="background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9))"></div>
            <img [src]="getImageUrl(series.backdrop, 'backdrop')" [alt]="series.title + ' backdrop'" class="backdrop-img"
                 (error)="$any($event.target).style.display='none'">
        </div>
        
        <div class="container position-relative" style="margin-top: -150px">
            <div class="row">
                <div class="col-md-3 mb-4">
                    <div id="poster" class="rounded shadow-lg">
                        <img [src]="getImageUrl(series.poster, 'poster')" [alt]="series.title + ' poster'" class="poster-img"
                             (error)="$any($event.target).style.display='none'">
                    </div>
                    
                    <!-- Action Buttons - Only for Admin -->
                    <div *ngIf="authService.isAdmin()" class="mt-4 d-flex flex-column gap-2">
                        <button class="btn btn-warning w-100" (click)="editSeries()">
                            <i class="fas fa-edit me-2"></i>Edit TV Series
                        </button>
                        <button class="btn btn-danger w-100 mb-2" (click)="deleteSeries()">
                            <i class="fas fa-trash me-2"></i>Delete TV Series
                        </button>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="details-info mb-5">
                        <h1 id="title" class="mb-3">{{ series.title }}</h1>
                        <div id="metadata" class="d-flex flex-wrap gap-3 mb-4">
                            <span id="year" *ngIf="series.year" class="meta-item"><i class="fas fa-calendar"></i> {{ series.year }}</span>
                            <span id="rating" *ngIf="series.imdb_rating" class="meta-item"><i class="fas fa-star"></i> {{ series.imdb_rating }}</span>
                            <span id="duration" *ngIf="series.total_seasons" class="meta-item"><i class="fas fa-tv"></i> {{ series.total_seasons }} Seasons</span>
                            <span id="category" *ngIf="series.category" class="meta-item"><i class="fas fa-film"></i> {{ series.category.name }}</span>
                        </div>
                        <p id="description" class="mb-4">{{ series.description }}</p>
                        <div id="trailer" class="mb-4" *ngIf="hasTrailer()">
                            <button class="btn btn-primary " (click)="openTrailerModal(trailerModal)">
                                <i class="fas fa-play me-2"></i>Watch Trailer
                            </button>
                        </div>
                        
                        <!-- Cast Section -->
                        <div id="cast" class="cast-section mt-4" *ngIf="series?.persons && (series.persons?.length || 0) > 0">
                            <h3>Cast</h3>
                            <div class="cast-grid">
                                <div *ngFor="let person of series.persons" class="cast-item">
                                    <div class="text-center">
                                        <img [src]="getImageUrl(person.profile_image, 'cast')" [alt]="person.name"
                                             class="cast-img"
                                             (error)="onImageError($event, '/assets/images/placeholder-profile.jpg')">
                                        <div class="cast-name">{{ person.name }}</div>
                                        <div *ngIf="person.character" class="cast-character text-muted">{{ person.character }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stato controllo crediti -->
                        <div *ngIf="checkingCredits" class="mb-3 d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Verifying credits...</span>
                        </div>
                        
                        <!-- Errore verifica crediti (solo per errori di sistema, non per crediti insufficienti) -->
                        <div *ngIf="creditsError && !insufficientCredits" class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error!</strong> An error occurred while verifying credits.
                        </div>
                        
                        <!-- Seasons Section -->
                        <div id="seasons" class="seasons-container mt-4" *ngIf="series?.seasons && (series.seasons?.length || 0) > 0">
                            <h3>Seasons</h3>
                            <div class="season-section mb-4" *ngFor="let season of getVisibleSeasons()">
                                <div class="season-header d-flex justify-content-between align-items-center p-3 bg-secondary bg-opacity-25 rounded" 
                                     role="button" 
                                     (click)="toggleSeason(season.season_number)">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas" [ngClass]="{'fa-chevron-down': isSeasonExpanded(season.season_number), 'fa-chevron-right': !isSeasonExpanded(season.season_number)}"></i>
                                        <span class="season-name">Season {{ season.season_number }}</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge episodes-count">{{ season.episodes.length }} Episodes</span>
                                        <span class="badge season-year">{{ season.year }}</span>
                                    </div>
                                </div>
                                <div class="episodes-list" [ngClass]="{'show': isSeasonExpanded(season.season_number)}" *ngIf="season.episodes && season.episodes.length > 0">
                                    <div class="episode-item p-2 mt-2 bg-secondary bg-opacity-10 rounded" *ngFor="let episode of getVisibleEpisodes(season)">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                                <span class="episode-number text-white fs-5" style="min-width: 35px;">{{ episode.episode_number }}</span>
                                                <div class="episode-still rounded" 
                                                     [style.background-image]="episode['still'] ? 'url(' + getImageUrl(episode['still'], 'still') + ')' : ''" 
                                                     style="width: 160px; height: 90px; background-size: cover; background-position: center; background-color: #2a2a2a; flex-shrink: 0;">
                                                </div>
                                                <div style="flex: 1; min-width: 0; max-height: 90px; display: flex; align-items: center;">
                                                    <h5 class="episode-title mb-0" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">{{ episode.title }}</h5>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary watch-button" 
                                                    [ngClass]="{'btn-primary': authService.isAdmin() || canPlayVideo, 'btn-secondary': !authService.isAdmin() && !canPlayVideo && !checkingCredits}"
                                                    (click)="openEpisodeContent(videoModal, episode)">
                                                <i class="fas" [ngClass]="{'fa-play': !checkingCredits, 'fa-spinner fa-spin': checkingCredits}"></i>
                                                <span class="ms-2">Watch</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Load More Episodes Button -->
                                    <div class="text-center mt-3" *ngIf="hasMoreEpisodes(season)">
                                        <button class="btn btn-primary load-more-btn" (click)="loadMoreEpisodes(season.season_number)">
                                            <i class="fas fa-plus me-2"></i>Load More Episodes
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Load More Seasons Button -->
                            <div class="text-center mt-4" *ngIf="hasMoreSeasons()">
                                <button class="btn btn-primary load-more-btn" (click)="loadMoreSeasons()">
                                    <i class="fas fa-plus me-2"></i>Load More Seasons
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>
</div>

<!-- Trailer Modal Template -->
<ng-template #trailerModal>
    <div class="modal-header">
        <h5 class="modal-title">Watch Trailer</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeTrailerModal()"></button>
    </div>
    <div class="modal-body">
        <div class="ratio ratio-16x9 position-relative">
            <!-- Overlay per crediti insufficienti -->
            <div *ngIf="insufficientCredits && !authService.isAdmin()" 
                 class="position-absolute w-100 h-100 d-flex flex-column justify-content-center align-items-center text-center p-3"
                 style="background-color: rgba(0,0,0,0.8); z-index: 1000; pointer-events: all;">
                <i class="fas fa-lock text-danger mb-3" style="font-size: 3rem;"></i>
                <p class="text-white mb-3">You don't have enough credits to play this content</p>
                <a href="javascript:void(0)" (click)="openCreditsModal()" class="btn btn-primary">
                    <i class="fas fa-coins me-2"></i>Purchase Credits
                </a>
            </div>
            
            <!-- Overlay cliccabile per consumo crediti YouTube (invisibile) -->
            <div *ngIf="trailerUrl && !videoUrl && !youtubeCreditsConsumed && !insufficientCredits && !authService.isAdmin()" 
                 class="position-absolute w-100 h-100"
                 style="background-color: transparent; z-index: 10; cursor: pointer;"
                 (click)="consumeCreditsForYouTube()">
            </div>
            
            <!-- Use video element for local files, iframe for YouTube -->
            <video *ngIf="videoUrl && !trailerUrl" [src]="videoUrl" controls class="w-100 h-100" style="background: #000;" (play)="onVideoPlay($event)">
                Your browser does not support the video tag.
            </video>
            <iframe *ngIf="trailerUrl && !videoUrl" [src]="trailerUrl" title="YouTube video player" frameborder="0" 
                allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                allowfullscreen></iframe>
        </div>
    </div>
</ng-template>

<!-- Video Modal Template -->
<ng-template #videoModal>
    <div class="modal-header">
        <h5 class="modal-title">Watch Episode</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeVideoModal()"></button>
    </div>
    <div class="modal-body">
        <div class="ratio ratio-16x9 position-relative">
            <!-- Overlay per crediti insufficienti -->
            <div *ngIf="insufficientCredits && !authService.isAdmin()" 
                 class="position-absolute w-100 h-100 d-flex flex-column justify-content-center align-items-center text-center p-3"
                 style="background-color: rgba(0,0,0,0.8); z-index: 1000; pointer-events: all;">
                <i class="fas fa-lock text-danger mb-3" style="font-size: 3rem;"></i>
                <p class="text-white mb-3">You don't have enough credits to play this content</p>
                <a href="javascript:void(0)" (click)="openCreditsModal()" class="btn btn-primary">
                    <i class="fas fa-coins me-2"></i>Purchase Credits
                </a>
            </div>
            
            <video #videoPlayer [src]="videoUrl" [controls]="!insufficientCredits || authService.isAdmin()" class="w-100 h-100" style="background: #000;" 
                  (play)="onVideoPlay($event)" (playing)="onVideoPlaying($event)" (timeupdate)="onVideoTimeUpdate($event)">
                Your browser does not support the video tag.
            </video>
        </div>
    </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteModal>
    <div class="modal-header">
        <h4 class="modal-title">Confirm Message</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="cancelDelete()"></button>
    </div>
    <div class="modal-body">
        <div class="text-center">
            <h5>Are you sure?</h5>
            <p class="mb-3">
                Do you want to delete the TV series <strong>"{{ series?.title }}"</strong>?
            </p>
        </div>
    </div>
  <div class="modal-footer d-flex justify-content-between">
    <button type="button" class="btn btn-danger flex-fill me-2" (click)="confirmDelete()" [disabled]="loading">
      <span *ngIf="loading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
      <i *ngIf="!loading" class="fas fa-trash me-2"></i>Delete
    </button>
    <button type="button" class="btn btn-secondary flex-fill" (click)="cancelDelete()">
      <i class="fas fa-times me-2"></i>Cancel
    </button>
  </div>
</ng-template>
<!-- footer -->
<app-footer></app-footer>
